#!/bin/bash


set -e


PATH=/var/vcap/packages/tinc/sbin:$PATH
PID_FILE=/var/vcap/sys/run/tinc/pid
LOG_DIR=/var/vcap/sys/log/tinc/

NAME=tinc
USER=vcap

function createHostsFiles(){
    NETWORK_NAME=<%= p('tinc.name') %>
    TINC_PATH=/var/vcap/packages/tinc/etc/tinc/$NETWORK_NAME
    HOST_PATH=$TINC_PATH/hosts
    
    mkdir -p $HOST_PATH

    <% link('nodes').instances.each_with_index do |instance, index| %>        
        HOSTFILE=$HOST_PATH/node<%= index %>
        rm $HOSTFILE
        echo "Address = <%= p('tinc.ip') %>.<%= index + 10 %>" >> $HOSTFILE
        echo "Subnet = <%= p('tinc.cidr') %>" >> $HOSTFILE
        echo "<%= link('nodes').p('tinc.public_key') %>" >> $HOSTFILE
    <% end %>

    echo "<%= p('tinc.private_key') %>" > $TINC_PATH/rsa_key.priv
    chmod 600 $TINC_PATH/rsa_key.priv
    echo "ifconfig <%= p('tinc.device') %> <%= p('tinc.ip') %>.<%= index + 10 %> netmask <%= p('tinc.netmask') %>" > $TINC_PATH/tinc-up
    chmod +x $TINC_PATH/tinc-up
    cp config/tinc.conf $TINC_PATH

}



case "$1" in
    start)
        createHostsFiles
        tincd -n <%= p('tinc.name') %> --pidfile $PID_FILE -D -d3 2>$LOG_DIR/stderr.log >$LOG_DIR/stdout.log
         

        ;;
    stop)

        
        ;;
    *)
        echo "Usage: $0 {start|stop|restart|reload|force-reload}" >&2
        RETVAL=1
        ;;
esac

exit "${RETVAL}"